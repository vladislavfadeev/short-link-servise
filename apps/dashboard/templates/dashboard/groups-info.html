{% extends "dashboard/layouts/base.html" %}
{% load dashboard_tags %}
{% load static %}

{% block title %} Dashboard {% endblock %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
{% endblock stylesheets %}

{% block breadcrumb %}
    {% load breadcrumb %}
<!-- [ breadcrumb ] start -->
        <nav aria-label="breadcrumb" itemscope itemtype="{% breadcrumb_schema %}">
            <ol class="breadcrumb mx-3 my-2">
                {% breadcrumb_home 'dashboard'%}
                {% breadcrumb_item 'groups' 'Мои группы' 1 %}
                {% breadcrumb_active 2 url=object.get_absolute_url title=object.title prefix='Просмотр статистики по группе: ' %}
            </ol>
        </nav>

<!-- [ breadcrumb ] end -->
{% endblock breadcrumb %}

{% block content %}

<!-- [ Main Content ] start -->
<div class="pcoded-main-container">
    <div class="pcoded-wrapper">

        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <!-- [ Main Content ] start -->
                        <div class="row">
                            <!--[ daily clicks section ] start-->
                            <div class="col-md-3">
                                <div class="card daily-sales">
                                    <div class="card-block">
                                        <h6 class="mb-4">Кликов за сегодня</h6>
                                        <div class="row d-flex align-items-center">
                                            <div class="col-9">
                                                <h3 class="f-w-300 d-flex align-items-center m-b-0">
                                                    <i class="feather icon-trending-up text-c-green f-30 m-r-10"></i>
                                                    <span id="day-entries-container" ></span>
                                                </h3>
                                            </div>
                                            <!-- <div class="col-3 text-right">
                                                    <p class="m-b-0">67%</p>
                                                </div> -->
                                        </div>
                                        <div class="progress m-t-30" style="height: 7px;">
                                            <div class="progress-bar progress-c-theme" role="progressbar"
                                                style="width: 100%;" aria-valuenow="100" aria-valuemin="0"
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--[ daily clicks section ] end-->
                            <!--[ weekly clicks section ] starts-->
                            <div class="col-md-3">
                                <div class="card weekly-sales">
                                    <div class="card-block">
                                        <h6 class="mb-4">Кликов за неделю</h6>
                                        <div class="row d-flex align-items-center">
                                            <div class="col-9">
                                                <h3 class="f-w-300 d-flex align-items-center  m-b-0">
                                                    <i class="feather icon-trending-up text-c-blue f-30 m-r-10"></i>
                                                    <span id="week-entries-container" ></span>
                                                </h3>
                                            </div>
                                            <!-- <div class="col-3 text-right">
                                                    <p class="m-b-0">36%</p>
                                                </div> -->
                                        </div>
                                        <div class="progress m-t-30" style="height: 7px;">
                                            <div class="progress-bar progress-c-theme" role="progressbar"
                                                style="width: 100%;" aria-valuenow="100" aria-valuemin="0"
                                                aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--[ weekly clicks section ] end-->
                            <!--[ monthly clicks section ] starts-->
                            <div class="col-md-3">
                                <div class="card Monthly-sales">
                                    <div class="card-block">
                                        <h6 class="mb-4">Кликов за месяц</h6>
                                        <div class="row d-flex align-items-center">
                                            <div class="col-9">
                                                <h3 class="f-w-300 d-flex align-items-center m-b-0">
                                                    <i class="feather icon-trending-up text-c-purple f-30 m-r-10"></i>
                                                    <span id="month-entries-container" ></span>
                                                </h3>
                                            </div>
                                            <!-- <div class="col-3 text-right">
                                                    <p class="m-b-0">36%</p>
                                                </div> -->
                                        </div>
                                        <div class="progress m-t-30" style="height: 7px;">
                                            <div class="progress-bar progress-c-theme" role="progressbar"
                                                style="width: 100%;" aria-valuenow="100" aria-valuemin="0"
                                                aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--[ monthly clicks section ] end-->
                            <!--[ year  sales section ] starts-->
                            <div class="col-md-3">
                                <div class="card yearly-sales">
                                    <div class="card-block">
                                        <h6 class="mb-4">За все время</h6>
                                        <div class="row d-flex align-items-center">
                                            <div class="col-9">
                                                <h3 class="f-w-300 d-flex align-items-center  m-b-0">
                                                    <i class="feather icon-trending-up text-c-red f-30 m-r-10"></i>
                                                    {{ activity.clicks }}
                                                </h3>
                                            </div>
                                            <!-- <div class="col-3 text-right">
                                                    <p class="m-b-0">80%</p>
                                                </div> -->
                                        </div>
                                        <div class="progress m-t-30" style="height: 7px;">
                                            <div class="progress-bar progress-c-theme" role="progressbar"
                                                style="width: 100%;" aria-valuenow="100" aria-valuemin="0"
                                                aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--[ year  sales section ] end-->
                            <!--[ Recent Users ] start-->
                            <div class="col-xl-8 col-md-6">
                                <!-- <div class="col-xl-6"> -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Динамика кликов</h5>
                                    </div>
                                    <div class="card-block">
                                        <!-- <div id="line-example" style="max-height:350px"></div> -->
                                        <canvas id="myChart" style="max-height: 340px;"></canvas>
                                    </div>
                                </div>
                                <!-- </div> -->
                            </div>
                            <!--[ Recent Users ] end-->

                            <!-- [ statistics year chart ] start -->
                            <div class="col-xl-4 col-md-6"> <!-- truncatechars- {{ value|truncatechars:7 }} -->
                                <div class="card">
                                    <div class="card-block">
                                        <div class="row align-items-center justify-content-center">
                                            <div class="col-sm-12 pb-1 mb-1 border-bottom">
                                                <h5 class="m-0">Включает в себя: </h5>
                                            </div>
                                            <div class="col-6 border-rigth">
                                                <h5 class="m-0">Ссылок</h5>
                                                <div class="row align-items-center">
                                                    <div class="col-3 mt-2">
                                                        <i class="feather icon-link-2 text-c-purple f-30"></i>
                                                    </div>
                                                    <h2 class="mt-3 ml-2 f-w-300">{{ activity.links }}</h2>
                                                </div>
                                                <!-- <label class="label theme-bg2 text-white f-14 f-w-400 float-left">34%</label> -->
                                            </div>
                                            <div class="col-6">
                                                <h5 class="m-0">Просроченных</h5>
                                                <div class="row align-items-center">
                                                    <div class="col-3 mt-2">
                                                        <i class="feather icon-clock text-c-red f-30"></i>
                                                    </div>
                                                    <h2 class="mt-3 ml-2 f-w-300">{{ object|expired_items:'linkmodel_set' }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-block border-bottom">
                                        <div class="row d-flex align-items-center">
                                            <div class="col-auto">
                                                <i class="feather icon-zap f-30 text-c-green"></i>
                                            </div>
                                            <div class="col">
                                                    <h3 id="max-link-container" class="f-w-300 long-link"></h3>
                                                <span class="d-block text-uppercase">Основной источник</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-block">
                                        <div class="row d-flex align-items-center">
                                            <div class="col-auto">
                                                <i class="feather icon-cpu f-30 text-c-blue"></i>
                                            </div>
                                            <div class="col">
                                                    <h3 id="max-device-container" class="f-w-300 long-link"></h3>
                                                <span class="d-block text-uppercase">Ключевое устройство</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- [ statistics year chart ] end -->
                            <div class="col-xl-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Устройства</h5>
                                    </div>
                                    <div class="card-block">
                                        <canvas id="myChart1"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Тип ОС</h5>
                                    </div>
                                    <div class="card-block">
                                        <canvas id="myChart2"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Браузеры</h5>
                                    </div>
                                    <div class="card-block">
                                        <canvas id="myChart3"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Источники</h5>
                                    </div>
                                    <div class="card-block">
                                        <canvas id="myChart4"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!--[social-media section] start-->
                            <!-- <div class="col-md-12 col-xl-4">
                                    <div class="card card-social">
                                        <div class="card-block border-bottom">
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col-auto">
                                                    <i class="fab fa-facebook-f text-primary f-36"></i>
                                                </div>
                                                <div class="col text-right">
                                                    <h3>12,281</h3>
                                                    <h5 class="text-c-green mb-0">+7.2% <span
                                                            class="text-muted">Total Likes</span></h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-block">
                                            <div class="row align-items-center justify-content-center card-active">
                                                <div class="col-6">
                                                    <h6 class="text-center m-b-10"><span
                                                            class="text-muted m-r-5">Target:</span>35,098</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                                                style="width:60%;height:6px;" aria-valuenow="60"
                                                                aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <h6 class="text-center  m-b-10"><span
                                                            class="text-muted m-r-5">Duration:</span>3,539</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar progress-c-theme2" role="progressbar"
                                                                style="width:45%;height:6px;" aria-valuenow="45"
                                                                aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xl-4">
                                    <div class="card card-social">
                                        <div class="card-block border-bottom">
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col-auto">
                                                    <i class="fab fa-twitter text-c-blue f-36"></i>
                                                </div>
                                                <div class="col text-right">
                                                    <h3>11,200</h3>
                                                    <h5 class="text-c-purple mb-0">+6.2% <span class="text-muted">Total Likes</span>
                                                    </h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-block">
                                            <div class="row align-items-center justify-content-center card-active">
                                                <div class="col-6">
                                                    <h6 class="text-center m-b-10"><span
                                                            class="text-muted m-r-5">Target:</span>34,185</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar progress-c-green" role="progressbar"
                                                                style="width:40%;height:6px;" aria-valuenow="40"
                                                                aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <h6 class="text-center  m-b-10"><span
                                                            class="text-muted m-r-5">Duration:</span>4,567</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar progress-c-blue" role="progressbar"
                                                                style="width:70%;height:6px;" aria-valuenow="70"
                                                                aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xl-4">
                                    <div class="card card-social">
                                        <div class="card-block border-bottom">
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col-auto">
                                                    <i class="fab fa-google-plus-g text-c-red f-36"></i>
                                                </div>
                                                <div class="col text-right">
                                                    <h3>10,500</h3>
                                                    <h5 class="text-c-blue mb-0">+5.9% <span
                                                            class="text-muted">Total Likes</span></h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-block">
                                            <div class="row align-items-center justify-content-center card-active">
                                                <div class="col-6">
                                                    <h6 class="text-center m-b-10"><span
                                                            class="text-muted m-r-5">Target:</span>25,998</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar progress-c-theme" role="progressbar"
                                                                style="width:80%;height:6px;" aria-valuenow="80"
                                                                aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <h6 class="text-center  m-b-10"><span
                                                            class="text-muted m-r-5">Duration:</span>7,753</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar progress-c-theme2" role="progressbar"
                                                                style="width:50%;height:6px;" aria-valuenow="50"
                                                                aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div> -->
                            <!--[social-media section] end-->
                        </div>
                        <!-- [ Main Content ] end -->
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- [ Main Content ] end -->

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ activity.date|json_script:"click-dynamic" }}
{{ activity.device|json_script:"device-types" }}
{{ activity.os|json_script:"os-types" }}
{{ activity.browser|json_script:"browser-types" }}
{{ activity.source|json_script:"sources" }}
<script>

    // 
    var dayEntriesData = JSON.parse(document.getElementById("click-dynamic").textContent);

    var currentDate = new Date();
    var monthEntries = 0;
    var weekEntries = 0;
    var dayEntries = 0;

    for (var i = 0; i < dayEntriesData.length; i++) {
        var entryDate = new Date(dayEntriesData[i].date);
        var timeDiff = Math.abs(currentDate - entryDate);
        var daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));

        if (daysDiff <= 30) {
            monthEntries += dayEntriesData[i].entries;
        }
        if (daysDiff <= 7) {
            weekEntries += dayEntriesData[i].entries;
        }
        if (daysDiff >= 0 && daysDiff <= 1) {
            dayEntries += dayEntriesData[i].entries;
        }
    }

    var dayEntriesContainer = document.getElementById("day-entries-container");
    var weekEntriesContainer = document.getElementById("week-entries-container");
    var monthEntriesContainer = document.getElementById("month-entries-container");
    dayEntriesContainer.textContent = dayEntries;
    weekEntriesContainer.textContent = weekEntries;
    monthEntriesContainer.textContent = monthEntries;
    // End 


    // Find result for 'The most popular souce' block
    function findMostDeviceEntries(deviceData) {
        let device = null;
        let entries = -Infinity;

        for (let i = 0; i < deviceData.length; i++) {
            let dict = deviceData[i];
            if (dict.entries > entries) {
                entries = dict.entries;
                device = dict.device;
            }
        }
        return device;
    }
    var linksData = JSON.parse(document.getElementById("device-types").textContent);
    var maxLinkContainer = document.getElementById("max-device-container");
    maxLinkContainer.textContent = findMostDeviceEntries(linksData);
    // End


    // Find result for 'The most popular souce' block
    function findMostLinkEntries(linksData) {
        let link = null;
        let entries = -Infinity;

        for (let i = 0; i < linksData.length; i++) {
            let dict = linksData[i];
            if (dict.entries > entries) {
                entries = dict.entries;
                link = dict.ref_link;
            }
        }
        return link;
    }
    var linksData = JSON.parse(document.getElementById("sources").textContent);
    var maxLinkContainer = document.getElementById("max-link-container");
    maxLinkContainer.textContent = findMostLinkEntries(linksData);
    // End


    // Create 'click dynamic' chart
    var clickDynamic = JSON.parse(document.getElementById('click-dynamic').textContent);
    var clickDynamicLabels = [];
    var clickDynamicEntries = [];

    for (var i = 0; i < clickDynamic.length; i++) {
        var dict = clickDynamic[i];
        var labels = dict["date"].slice(0, 10);
        var entries = dict["entries"];

        clickDynamicLabels.push(labels);
        clickDynamicEntries.push(entries);
    }
    const ctx = document.getElementById('myChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: clickDynamicLabels,
            datasets: [{
                data: clickDynamicEntries,
                fill: true,
                borderColor: 'rgb(102, 193, 253)',
                backgroundColor: 'rgba(154, 202, 235, 0.3)',
                tension: 0.3,
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                }
            }
        },
    });
    //  End 'click dynamic' chart


    // Create 'device types' chart
    var deviceTypes = JSON.parse(document.getElementById('device-types').textContent);
    var deviceTypesLabels = [];
    var deviceTypesEntries = [];

    for (var i = 0; i < deviceTypes.length; i++) {
        var dict = deviceTypes[i];
        var labels = dict["device"];
        var entries = dict["entries"];

        deviceTypesLabels.push(labels);
        deviceTypesEntries.push(entries);
    }
    const ctx1 = document.getElementById('myChart1');
    new Chart(ctx1, {
        type: 'polarArea',
        data: {
            labels: deviceTypesLabels,
            datasets: [{
                data: deviceTypesEntries,
            }]
        },
    });
    // End 'device types' chart


    // Create 'os-types' chart
    var osTypes = JSON.parse(document.getElementById('os-types').textContent);
    var osTypesLabels = [];
    var osTypesEntries = [];

    for (var i = 0; i < osTypes.length; i++) {
        var dict = osTypes[i];
        var labels = dict["os"];
        var entries = dict["entries"];

        osTypesLabels.push(labels);
        osTypesEntries.push(entries);
    }
    const ctx2 = document.getElementById('myChart2');
    new Chart(ctx2, {
        type: 'polarArea',
        data: {
            labels: osTypesLabels,
            datasets: [{
                data: osTypesEntries,
            }],
        },
    });
    // End 'os-types' chart


    // Create 'browser-types' chart
    var browserTypes = JSON.parse(document.getElementById('browser-types').textContent);
    var browserTypesLabels = [];
    var browserTypesEntries = [];

    for (var i = 0; i < browserTypes.length; i++) {
        var dict = browserTypes[i];
        var labels = dict["browser"];
        var entries = dict["entries"];

        browserTypesLabels.push(labels);
        browserTypesEntries.push(entries);
    }
    const ctx3 = document.getElementById('myChart3');
    new Chart(ctx3, {
        type: 'polarArea',
        data: {
            labels: browserTypesLabels,
            datasets: [{
                data: browserTypesEntries,
            }],
        },
    });
    // End 'browser-types' chart


    // Create 'sources' chart
    var sourceTypes = JSON.parse(document.getElementById('sources').textContent);
    var sourceTypesLabels = [];
    var sourceTypesEntries = [];
    for (var i = 0; i < sourceTypes.length; i++) {
        var dict = sourceTypes[i];
        var labels = dict["ref_link"];
        var entries = dict["entries"];

        sourceTypesLabels.push(labels);
        sourceTypesEntries.push(entries);
    }
    const ctx4 = document.getElementById('myChart4');
    new Chart(ctx4, {
        type: 'polarArea',
        data: {
            labels: sourceTypesLabels,
            datasets: [{
                data: sourceTypesEntries,
            }],
        },
    });
    // End 'sources' chart


</script>


{% endblock javascripts %}